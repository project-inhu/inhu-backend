name: Deploy to Development

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop

jobs:
  # 1. 변경된 파일 감지
  check-changes:
    name: Check for Changes
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.deployment-gate.outputs.any_modified }}
      should_db_down: ${{ steps.db-check.outputs.any_modified }}
      user_changed: ${{ steps.user-filter.outputs.any_modified }}
      admin_changed: ${{ steps.admin-filter.outputs.any_modified }}
      batch_changed: ${{ steps.batch-filter.outputs.any_modified }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # User 서버 변경 감지
      - name: Check for User Service Changes
        id: user-filter
        uses: tj-actions/changed-files@v44
        with:
          files: |
            apps/user-server/**
            libs/**
          files_ignore: |
            **/*.md
            libs/testing/**

      # Admin 서버 변경 감지
      - name: Check for Admin Service Changes
        id: admin-filter
        uses: tj-actions/changed-files@v44
        with:
          files: |
            apps/admin-server/**
            libs/**
          files_ignore: |
            **/*.md
            libs/testing/**

      # Batch 서버 변경 감지
      - name: Check for Batch Service Changes
        id: batch-filter
        uses: tj-actions/changed-files@v44
        with:
          files: |
            apps/batch-server/**
            libs/**
          files_ignore: |
            **/*.md
            libs/testing/**

      # 실제 배포 트리거 파일 변경 감지
      - name: Check for deployable Changes
        id: deployment-gate
        uses: tj-actions/changed-files@v44
        with:
          files: |
            .github/workflows/deploy-dev.yml
            apps/**/src/**
            libs/**
            prisma/**
            package.json
            package-lock.json
            scripts/dev-infra/**
            scripts/rdb/**
          files_ignore: |
            libs/testing/**
            **/*.md

      # DB infra 관련 변경 감지
      - name: Check for database infrastructure Changes
        id: db-check
        uses: tj-actions/changed-files@v44
        with:
          files: |
            scripts/dev-infra/**
            scripts/rdb/**
            prisma/**

      - name: echo outputs for debugging
        run: |
          echo "user_changed=${{ steps.user-filter.outputs.any_modified }}"
          echo "admin_changed=${{ steps.admin-filter.outputs.any_modified }}"
          echo "batch_changed=${{ steps.batch-filter.outputs.any_modified }}"
          echo "should_deploy=${{ steps.deployment-gate.outputs.any_modified }}"
          echo "should_db_down=${{ steps.db-check.outputs.any_modified }}"
          echo "Deployment gate outputs: ${{ toJSON(steps.deployment-gate.outputs) }}"
          echo "DB check outputs: ${{ toJSON(steps.db-check.outputs) }}"

  # 2. 공통 작업 실행 (DB reset, seed, npm ci)
  run-common-tasks:
    name: Run Common tasks
    needs: check-changes
    if: github.event_name == 'push' && needs.check-changes.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Execute common tasks on server
        env:
          HOST: ${{ secrets.RASPBERRY_PI_HOST }}
          USER: ${{ secrets.RASPBERRY_PI_USER }}
          PASSWORD: ${{ secrets.RASPBERRY_PI_PASSWORD }}
          PORT: ${{ secrets.RASPBERRY_PI_PORT }}
          DB_DOWN: ${{ needs.check-changes.outputs.should_db_down }}
          USER_CHANGED: ${{ needs.check-changes.outputs.user_changed }}
          ADMIN_CHANGED: ${{ needs.check-changes.outputs.admin_changed }}
          BATCH_CHANGED: ${{ needs.check-changes.outputs.batch_changed }}

        run: |
          echo "[deploy] should_db_down=$DB_DOWN"
          sudo apt-get update && sudo apt-get install -y sshpass
          sshpass -p "$PASSWORD" scp -P "$PORT" -o StrictHostKeyChecking=no scripts/deploy-dev-infra-script.sh $USER@$HOST:~/inhu-backend/
          sshpass -p "$PASSWORD" ssh -p "$PORT" -o StrictHostKeyChecking=no $USER@$HOST \
            "chmod +x ~/inhu-backend/deploy-dev-infra-script.sh"
          sshpass -p "$PASSWORD" ssh -p "$PORT" -o StrictHostKeyChecking=no $USER@$HOST \
            "DB_DOWN_FLAG='$DB_DOWN' USER_CHANGED='$USER_CHANGED' ADMIN_CHANGED='$ADMIN_CHANGED' BATCH_CHANGED='$BATCH_CHANGED' ~/inhu-backend/deploy-dev-infra-script.sh"

  # 3. 서비스별 워크플로우 호출
  call-user-workflow:
    name: Trigger User workflow
    needs: [check-changes, run-common-tasks]
    if: needs.check-changes.outputs.user_changed == 'true'
    uses: ./.github/workflows/deploy-dev-user.yml
    secrets: inherit

  call-admin-workflow:
    name: Trigger Admin workflow
    needs: [check-changes, run-common-tasks]
    if: needs.check-changes.outputs.admin_changed == 'true'
    uses: ./.github/workflows/deploy-dev-admin.yml
    secrets: inherit

  call-batch-workflow:
    name: Trigger Batch workflow
    needs: [check-changes, run-common-tasks]
    if: needs.check-changes.outputs.batch_changed == 'true'
    uses: ./.github/workflows/deploy-dev-batch.yml
    secrets: inherit
